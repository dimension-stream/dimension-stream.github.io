"use strict";(self.webpackChunkdimension_stream_github_io=self.webpackChunkdimension_stream_github_io||[]).push([[142],{2142:(n,e,t)=>{t.r(e),t.d(e,{init:()=>Z,toggleHeadTracking:()=>A});var a,r,i=t(9477),o=t(9365),s=t(7885),d=t(8761),c=(new URLSearchParams(window.location.search).get("id"),78/180*Math.PI),l={camYBias:0,camZBias:0,eyeSizeBias:0};d.r.onGUIConstructed=function(n){var e=n.addFolder("VirtualHole");e.add(l,"eyeSizeBias",-10,10).step(.01),e.add(l,"camYBias",-10,10).step(.01),e.add(l,"camZBias",-10,10).step(.01),e.open()},d.r.onCameraChanged=function(n){var e=n.video.videoWidth,t=n.video.videoHeight;Math.atan(Math.tan(c/2)*e/Math.sqrt(t*t+e*e)),Math.atan(Math.tan(c/2)*t/Math.sqrt(t*t+e*e)),a=[e,t],r=.5*Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.tan(.5*Math.PI-.5*c)};var u=[263,362],v=[33,133];function f(n,e){return[n[0]-e[0],n[1]-e[1],n[2]-e[2]]}function m(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function p(n){var e=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);return n[0]/=e,n[1]/=e,n[2]/=e,n}var h=!1,_=[[0,0,0],[0,0,0],[0,0,0]],g=[[0,0,0],[0,0,0],[0,0,0]];var y,x,w,b,M,S=t(5149),I=t(4376),k=function(n,e,t,a){return new(t||(t=Promise))((function(r,i){function o(n){try{d(a.next(n))}catch(n){i(n)}}function s(n){try{d(a.throw(n))}catch(n){i(n)}}function d(n){var e;n.done?r(n.value):(e=n.value,e instanceof t?e:new t((function(n){n(e)}))).then(o,s)}d((a=a.apply(n,e||[])).next())}))},z=function(n,e){var t,a,r,i,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(d){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(o=0)),o;)try{if(t=1,a&&(r=2&s[0]?a.return:s[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,s[1])).done)return r;switch(a=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,a=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((r=(r=o.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(n,o)}catch(n){s=[6,n],a=0}finally{t=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,d])}}},P=t(9530),T={Translation:{X:0,Y:0,Z:0},Rotation:{X:0,Y:0,Z:0},Scale:.05,"Use headtracking":!1};function B(n,e){var t=n.addFolder("Viewer");if(e){var a=t.addFolder("Transforms"),r=a.addFolder("Translation");r.add(T.Translation,"X",-.1,.1).step(.001),r.add(T.Translation,"Y",-.1,.1).step(.001),r.add(T.Translation,"Z",-.1,.1).step(.001);var i=a.addFolder("Rotation");i.add(T.Rotation,"X",0,2*Math.PI).step(.001),i.add(T.Rotation,"Y",0,2*Math.PI).step(.001),i.add(T.Rotation,"Z",0,2*Math.PI).step(.001),a.add(T,"Scale",.01,.1).step(.001)}t.add(T,"Use headtracking").onChange((function(n){return A(n)})),t.open()}var R,E,F=new I.XS({width:300});function C(){E===C?(console.log("normal rendering"),y.render(x,w)):console.log("skipped rendering")}function H(){b.rotation.set(T.Rotation.X+Math.PI/2,T.Rotation.Z+Math.PI,T.Rotation.Y+Math.PI),b.scale.set(T.Scale*M[0],T.Scale*M[1],T.Scale*M[2]),b.position.set(T.Translation.X,T.Translation.Y,T.Translation.Z),S.Dd(!1).then((function(n){if(null!=n&&n.length>0){var e=function(n,e,t,a){void 0===a&&(a=!0),a&&(n=function(n){var e=1/4.125;if(h)return h=!1,g[0]=n,g[1]=n,_[0]=n,_[1]=n,n;var t=[(-.25*g[0][0]+.375*g[1][0]+n[0]+2*_[0][0]+_[1][0])*e,(-.25*g[0][1]+.375*g[1][1]+n[1]+2*_[0][1]+_[1][1])*e,(-.25*g[0][2]+.375*g[1][2]+n[2]+2*_[0][2]+_[1][2])*e];return g[1]=g[0],g[0]=t,_[1]=_[0],_[0]=n,t}(n));var r,i,o,s,d,c,l,u,v,y,x,w,b,M,S,I,k=-e/2,z=-t/2;return r=[k,z,0],i=[k+e,z,0],o=[k,z+t,0],s=[n[0],n[1],n[2]],d=.1,c=p(f(i,r)),l=p(f(o,r)),u=p(function(n,e){return[n[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]]}(c,l)),v=f(r,s),y=f(i,s),x=f(o,s),w=-m(v,u),b=m(c,v)*d/w,M=m(c,y)*d/w,S=m(l,v)*d/w,I=m(l,x)*d/w,[[.2/(M-b),0,0,0,0,.2/(I-S),0,0,(M+b)/(M-b),(I+S)/(I-S),-10.1/9.9,-1,0,0,-2/9.9,0],[c[0],l[0],u[0],0,c[1],l[1],u[1],0,c[2],l[2],u[2],0,s[0],s[1],s[2],1]]}(function(n){var e,t,i=n[0].keypoints[u[0]],o=n[0].keypoints[u[1]],s=n[0].keypoints[v[0]],d=n[0].keypoints[v[1]],c=function(n,e){var t=n.x-e.x,a=n.y-e.y;return Math.sqrt(t*t+a*a)},f=c(i,o),m=c(s,d),p=(e=Math.max(f,m),(24.2+l.eyeSizeBias)*r/e-l.camZBias),h=(t=[n[0].keypoints[6].x,n[0].keypoints[6].y],[Math.atan2(a[0]/2-t[0],r),Math.atan2(a[1]/2-t[1],r)]);return[Math.tan(h[0])*p,Math.tan(h[1])*p+l.camYBias,p+l.camZBias].map((function(n){return n/1e3}))}(n),.621,.341);(new i.yGw).fromArray(e[1]).decompose(w.position,w.quaternion,w.scale),w.projectionMatrix.fromArray(e[0]),w.projectionMatrixInverse.copy(w.projectionMatrix).invert(),w.updateMatrixWorld(),y.render(x,w)}requestAnimationFrame(E)}))}F.domElement.id="gui",B(F,!1),d.r.onGUIConstructed=(R=d.r.onGUIConstructed,function(n){R(n),F.destroy(),B(n,!0),n.__folders.Backend.hide(),n.__folders.Model.hide(),n.__folders.Camera.close(),n.__folders.VirtualHole.close()});var U=function(){return k(this,void 0,void 0,(function(){var n=this;return z(this,(function(e){return this.initialized||this.pending?[2,this.initialized]:(this.pending=!0,[2,d.S().then((function(){return n.pending=!1,n.initialized=!0,n.initialized}))])}))}))}.bind({initialized:!1,pending:!1});function A(n){return k(this,void 0,void 0,(function(){return z(this,(function(e){return n?U().then((function(n){n&&(E=H,requestAnimationFrame(E))})):(E=C,requestAnimationFrame(E)),[2]}))}))}var V={uniforms:{u_data:{value:-1},u_inv_modelview_pos:{value:-1}},vertexShader:'\n        uniform vec3 u_inv_modelview_pos;\n        out vec3 v_rd;\n        void main() {\n            // Transform rd to "aabb" space.\n            v_rd = position.xyz - u_inv_modelview_pos;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }',fragmentShader:'\n        precision highp float;\n        precision highp sampler3D;\n        uniform vec3 u_inv_modelview_pos;\n        uniform sampler3D u_data;\n        in vec3 v_rd;\n\n        float min_component(in vec3 v) {\n            return min(min(v.x, v.y), v.z);\n        }\n\n        float max_component(in vec3  v) {\n            return max(max(v.x, v.y), v.z);\n        }\n\n        // Intersect a ray with aabb where aabb.mix.xyz = -1, and aabb.max.xyz = 1.\n        // returns vec2(min_t, max_t).\n        vec2 boxIntersection(in vec3 ro, in vec3 rd) {\n            vec3 m = 1.0/rd;\n            vec3 n = ro*m;\n            vec3 t0 = -m - n;\n            vec3 t1 = m - n;\n            // isect if mint <= maxt;\n            return vec2(max_component(min(t0,t1)), min_component(max(t0,t1)));\n        }\n\n        float hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }\n        const float E = 2.7182818284;\n        void main() {\n            // Transform rays to "aabb" space.\n            vec3 rd = normalize(v_rd);\n            vec3 ro = u_inv_modelview_pos;\n            vec2 ti = boxIntersection(ro, rd);\n\n            vec3 H = vec3(0.0);\n            float V_i = 0.0;\n            const float dt = 2.0/512.0;\n            // for(float t = max(ti.x, 0.0) + 1.0*dt*(2.0*hash(rd.xy)-1.0); (t < ti.y); t+=dt)\n            for(float t = max(ti.x, 0.0); (t < ti.y); t+=dt)\n            {\n                vec3 pos = ro + t*rd;\n                // pos.xyz is in range (-1, 1).\n                vec3 uv = 0.5*pos+0.5;\n                vec4 val = texture(u_data, uv);\n                val.a = 256.0*(exp(val.a)-1.0)/(E-1.0); // uint8(255*log((e-1)*clamp(v,0,S)/S + 1)), S=256\n                // val.a = 256.0*val.a; // uint8(255*clamp(v,0,S)/S), S=256\n                // float v = val.a; // float\n                if(val.a > 1.0)\n                {\n                    float v = val.a*dt;\n                    H += exp(-V_i) * (1.0 - exp(-v)) * val.rgb;\n                    V_i += v;\n                }\n            }\n            // V_i = V_i*smoothstep(0.1, 1.0, V_i);\n            gl_FragColor.rgb = H + exp(-V_i) * vec3(0.0);\n            gl_FragColor.a = 1.0;\n        }'};function Y(){var n=document.getElementById("volume-canvas");return[n.clientWidth,n.clientHeight]}function Z(n){var e=this,t=document.getElementById("volume-canvas");y=new i.CP7({antialias:!1,canvas:t});var a=Y();y.setSize(a[0],a[1]),window.addEventListener("resize",q),x=new i.xsS,(w=new i.cPb(60,a[0]/a[1],.1,50)).position.set(-2.5,2.5,2.5),w.lookAt(0,0,0),new o.z(w,y.domElement).addEventListener("change",C),x.add(w);var r=document.getElementById("progress"),d=document.getElementById("progress_bar"),c=document.getElementById("progress_text");(new i.hH6).setResponseType("arraybuffer").load("/3d_models/"+n+".tar.gz",(function(n){return k(e,void 0,void 0,(function(){var e,t,a,o,d,c,l,u,v,f;return z(this,(function(m){switch(m.label){case 0:return e=s.ec(new Uint8Array(n)),[4,P(e.buffer).then((function(n){console.log(n)}),(function(n){console.log(n)}),(function(n){if(console.log(n),"grid.bin"===n.name)t=n.buffer;else if("grid.json"===n.name){var e=n.readAsJSON();a=e.GRID_RES,M=e.GRID_HALF_SIDE;var r=e.FORMAT;o="UCHAR"==r?i.ywz:i.VzW}}))];case 1:return m.sent(),d=new Uint8Array(t),(c=new i.JUT(d,a[0],a[1],a[2])).format=i.wk1,c.type=o,c.magFilter=i.wem,c.minFilter=i.wem,c.needsUpdate=!0,c.generateMipmaps=!1,l=V,(u=i.rDY.clone(l.uniforms)).u_data.value=c,u.u_inv_modelview_pos.value=new i.Pa4,v=new i.jyz({uniforms:u,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,side:i._Li}),f=new i.DvJ(2,2,2),(b=new i.Kj0(f,v)).rotation.set(Math.PI/2,Math.PI,Math.PI),b.scale.set(M[0],M[1],M[2]),b.onBeforeRender=function(n,e,t,a,r,i){r.uniforms.u_inv_modelview_pos.value.setFromMatrixColumn(t.matrixWorldInverse.clone().multiply(b.matrixWorld).invert(),3)},x.add(b),r.style.display="none",A(T["Use headtracking"]),[2]}}))}))}),(function(n){n.loaded===n.total?c.innerHTML="Unpacking...":c.innerHTML=Math.round(n.loaded/n.total*100)+"%",d.value=n.loaded/n.total*100}),(function(n){console.log("Error: "+n)}))}function q(){var n=Y();w.aspect=n[0]/n[1],w.updateProjectionMatrix(),y.setSize(n[0],n[1])}}}]);