"use strict";(self.webpackChunkdimension_stream_github_io=self.webpackChunkdimension_stream_github_io||[]).push([[80],{8080:(n,t,e)=>{e.r(t),e.d(t,{init:()=>nn});var a,r,o=e(9477),i=e(9365),u=e(7885),c=e(4376),l=e(8761),s=e(5149),d=(new URLSearchParams(window.location.search).get("id"),78/180*Math.PI),f={camYBias:0,camZBias:0,eyeSizeBias:0};l.r.onGUIConstructed=function(n){var t=n.addFolder("VirtualHole");t.add(f,"eyeSizeBias",-10,10).step(.01),t.add(f,"camYBias",-10,10).step(.01),t.add(f,"camZBias",-10,10).step(.01),t.open()};var v=24.2;l.r.onCameraChanged=function(n){var t=n.video.videoWidth,e=n.video.videoHeight;Math.atan(Math.tan(d/2)*t/Math.sqrt(e*e+t*t)),Math.atan(Math.tan(d/2)*e/Math.sqrt(e*e+t*t)),a=[t,e],r=.5*Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.tan(.5*Math.PI-.5*d)};var m=[263,362],p=[33,133],h=6;function _(n){var t,e,o=n[0].keypoints[m[0]],i=n[0].keypoints[m[1]],u=n[0].keypoints[p[0]],c=n[0].keypoints[p[1]],l=function(n,t){var e=n.x-t.x,a=n.y-t.y;return Math.sqrt(e*e+a*a)},s=l(o,i),d=l(u,c),_=(t=Math.max(s,d),(v+f.eyeSizeBias)*r/t-f.camZBias),b=(e=[n[0].keypoints[h].x,n[0].keypoints[h].y],[Math.atan2(a[0]/2-e[0],r),Math.atan2(a[1]/2-e[1],r)]);return[Math.tan(b[0])*_,Math.tan(b[1])*_+f.camYBias,_+f.camZBias].map((function(n){return n/1e3}))}function b(n,t){return[n[0]-t[0],n[1]-t[1],n[2]-t[2]]}function x(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function y(n){var t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);return n[0]/=t,n[1]/=t,n[2]/=t,n}var w=!1,g=[[0,0,0],[0,0,0],[0,0,0]],M=[[0,0,0],[0,0,0],[0,0,0]];var S,k,z,I=e(3644),R=function(n,t,e,a){return new(e||(e=Promise))((function(r,o){function i(n){try{c(a.next(n))}catch(n){o(n)}}function u(n){try{c(a.throw(n))}catch(n){o(n)}}function c(n){var t;n.done?r(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(i,u)}c((a=a.apply(n,t||[])).next())}))},C=function(n,t){var e,a,r,o,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(c){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(i=0)),i;)try{if(e=1,a&&(r=2&u[0]?a.return:u[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,u[1])).done)return r;switch(a=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,a=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(n,i)}catch(n){u=[6,n],a=0}finally{e=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}},F=new o.cPb;F.matrixAutoUpdate=!1;var T=.621,B={Translation:{X:0,Y:0,Z:0},Rotation:{X:0,Y:0,Z:0},Scale:.05,"Use headtracking":!1};function E(){V===Z&&requestAnimationFrame(V)}function P(n,t){var e=n.addFolder("Viewer");if(t){var a=e.addFolder("Transforms"),r=a.addFolder("Translation");r.add(B.Translation,"X",-.1,.1).step(.001).onChange(E),r.add(B.Translation,"Y",-.1,.1).step(.001).onChange(E),r.add(B.Translation,"Z",-.1,.1).step(.001).onChange(E),a.add(B,"Scale",.01,.1).step(.001).onChange(E)}e.add(B,"Use headtracking").onChange((function(n){return D(n)})),e.open()}var U,A=new c.XS({width:300});A.domElement.id="gui",P(A,!0),l.r.onGUIConstructed=(U=l.r.onGUIConstructed,function(n){U(n),A.destroy(),P(n,!0),n.__folders.Backend.hide(),n.__folders.Model.hide(),n.__folders.Camera.close(),n.__folders.VirtualHole.close()});var V,H=new o.Tme;function Y(){H.scale.set(B.Scale,B.Scale,B.Scale),H.position.set(B.Translation.X,B.Translation.Y,B.Translation.Z),H.updateMatrix()}function Z(){V===Z?(I.d.beginStats(),Y(),console.log("normal rendering"),H.rotation.set(B.Rotation.X,B.Rotation.Y,B.Rotation.Z),H.updateMatrix(),S.render(k,z),I.d.endStats()):console.log("skipped rendering")}function q(){R(this,void 0,void 0,(function(){return C(this,(function(n){return[2,I.d.beginStats()]}))})).then(Y).then((function(){return s.Dd(!1)})).then((function(n){if(null!=n&&n.length>0){var t=G(),e=function(n,t,e,a){void 0===a&&(a=!0),a&&(n=function(n){var t=1/4.125;if(w)return w=!1,M[0]=n,M[1]=n,g[0]=n,g[1]=n,n;var e=[(-.25*M[0][0]+.375*M[1][0]+n[0]+2*g[0][0]+g[1][0])*t,(-.25*M[0][1]+.375*M[1][1]+n[1]+2*g[0][1]+g[1][1])*t,(-.25*M[0][2]+.375*M[1][2]+n[2]+2*g[0][2]+g[1][2])*t];return M[1]=M[0],M[0]=e,g[1]=g[0],g[0]=n,e}(n));var r,o,i,u,c,l,s,d,f,v,m,p,h,_,S,k,z=-t/2,I=-e/2;return r=[z,I,0],o=[z+t,I,0],i=[z,I+e,0],u=[n[0],n[1],n[2]],c=.1,l=y(b(o,r)),s=y(b(i,r)),d=y(function(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}(l,s)),f=b(r,u),v=b(o,u),m=b(i,u),p=-x(f,d),h=x(l,f)*c/p,_=x(l,v)*c/p,S=x(s,f)*c/p,k=x(s,m)*c/p,[[.2/(_-h),0,0,0,0,.2/(k-S),0,0,(_+h)/(_-h),(k+S)/(k-S),-10.1/9.9,-1,0,0,-2/9.9,0],[l[0],s[0],d[0],0,l[1],s[1],d[1],0,l[2],s[2],d[2],0,u[0],u[1],u[2],1]]}(_(n),T,T*t[1]/t[0]),a=(new o._fP).setFromEuler(new o.USm(B.Rotation.X,B.Rotation.Y,B.Rotation.Z)),r=(new o._fP).setFromRotationMatrix(z.matrixWorld.clone().invert());H.rotation.setFromQuaternion(r.multiply(a)),F.matrixWorld.fromArray(e[1]),F.matrixWorld.decompose(F.position,F.quaternion,F.scale),F.projectionMatrix.fromArray(e[0]),F.matrixWorldInverse.copy(F.matrixWorld).invert(),F.projectionMatrixInverse.copy(F.projectionMatrix).invert(),S.render(k,F)}requestAnimationFrame(V)})).then((function(){return I.d.endStats()}))}var j=function(){return R(this,void 0,void 0,(function(){var n=this;return C(this,(function(t){return this.initialized||this.pending?[2,this.initialized]:(this.pending=!0,[2,l.S().then((function(){return n.pending=!1,n.initialized=!0,n.initialized}))])}))}))}.bind({initialized:!1,pending:!1});function D(n){return R(this,void 0,void 0,(function(){return C(this,(function(t){return n?j().then((function(n){n&&(V=q,requestAnimationFrame(V))})):(V=Z,requestAnimationFrame(V)),[2]}))}))}function G(){var n=document.getElementById("volume-canvas");return[n.clientWidth,n.clientHeight]}var W,X,L,J,O,K=function(n,t,e,a){return new(e||(e=Promise))((function(r,o){function i(n){try{c(a.next(n))}catch(n){o(n)}}function u(n){try{c(a.throw(n))}catch(n){o(n)}}function c(n){var t;n.done?r(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(i,u)}c((a=a.apply(n,t||[])).next())}))},N=function(n,t){var e,a,r,o,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(c){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(i=0)),i;)try{if(e=1,a&&(r=2&u[0]?a.return:u[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,u[1])).done)return r;switch(a=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,a=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(n,i)}catch(n){u=[6,n],a=0}finally{e=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}},Q=e(9530),$={uniforms:{u_data:{value:-1},u_aabb_min:{value:-1},u_aabb_max:{value:-1},transformMatrix:{value:-1}},vertexShader:"\n        uniform mat4 transformMatrix;\n        out vec3 v_rd_world;\n        out vec3 v_ro_world;\n        void main() {\n            mat4 modifiedViewMatrix = viewMatrix * transformMatrix;\n            v_ro_world = inverse(modifiedViewMatrix)[3].xyz;\n            v_rd_world = (modelMatrix * vec4(position, 1.0)).xyz - v_ro_world;\n            gl_Position = projectionMatrix * modifiedViewMatrix * modelMatrix * vec4(position, 1.0);\n        }",fragmentShader:'\n        precision highp float;\n        precision highp sampler3D;\n        uniform vec3 u_aabb_min;\n        uniform vec3 u_aabb_max;\n        uniform sampler3D u_data;\n        in vec3 v_rd_world;\n        in vec3 v_ro_world;\n\n        float min_component(in vec3 v) {\n            return min(min(v.x, v.y), v.z);\n        }\n\n        float max_component(in vec3  v) {\n            return max(max(v.x, v.y), v.z);\n        }\n\n        vec2 aabbIntersection(in vec3 ro, in vec3 rd) {\n            vec3 m = 1.0/rd;\n            vec3 t0 = (u_aabb_min - ro)*m;\n            vec3 t1 = (u_aabb_max - ro)*m;\n            // isect if mint <= maxt;\n            return vec2(max_component(min(t0,t1)), min_component(max(t0,t1)));\n        }\n\n        vec3 to_texcoord(in vec3 pos)\n        {\n            return (pos - u_aabb_min)/(u_aabb_max - u_aabb_min);\n        }\n\n        float hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }\n        const float E = 2.7182818284;\n        void main() {\n            // Transform rays to "aabb" space.\n            vec3 rd = normalize(v_rd_world);\n            vec3 ro = v_ro_world;\n            vec2 ti = aabbIntersection(v_ro_world, rd);\n\n            vec3 H = vec3(0.0);\n            float V_i = 0.0;\n            const float dt = 2.0/512.0;\n            // for(float t = max(ti.x, 0.0) + 1.0*dt*(2.0*hash(rd.xy)-1.0); (t < ti.y); t+=dt)\n            for(float t = max(ti.x, 0.0); (t < ti.y); t+=dt)\n            {\n                vec3 pos = ro + t*rd;\n                    if(pos.x <= (u_aabb_min.x + 0.01) ||\n                       pos.y <= (u_aabb_min.y + 0.01) || \n                       pos.z <= (u_aabb_min.z + 0.01) || \n                       pos.x >= (u_aabb_max.x - 0.01) || \n                       pos.y >= (u_aabb_max.y - 0.01) || \n                       pos.z >= (u_aabb_max.z - 0.01) )\n                    continue;\n\n                    \n                vec3 uv = to_texcoord(pos);\n                // gl_FragColor = vec4(uv, 1);\n                // return;\n                vec4 val = texture(u_data, uv);\n                val.a = 256.0*(exp(val.a)-1.0)/(E-1.0); // uint8(255*log((e-1)*clamp(v,0,S)/S + 1)), S=256\n                // val.a = 256.0*val.a; // uint8(255*clamp(v,0,S)/S), S=256\n                // float v = val.a; // float\n                if(val.a > 1.0)\n                {\n                    float v = val.a*dt;\n                    H += exp(-V_i) * (1.0 - exp(-v)) * val.rgb;\n                    V_i += v;\n                }\n            }\n            // V_i = V_i*smoothstep(0.1, 1.0, V_i);\n            gl_FragColor.rgb = H + exp(-V_i) * vec3(0.0);\n            gl_FragColor.a = 1.0;\n        }'};function nn(n){var t=this,e=document.getElementById("volume-canvas");W=new o.CP7({antialias:!1,canvas:e});var a=G();W.setSize(a[0],a[1]),window.addEventListener("resize",tn),X=new o.xsS,(L=new o.cPb(60,a[0]/a[1],.1,50)).position.set(-2.5*B.Scale,2.5*B.Scale,2.5*B.Scale),L.lookAt(0,0,0),new i.z(L,W.domElement).addEventListener("change",Z),X.add(L);var r=document.getElementById("progress"),c=document.getElementById("progress_bar"),l=document.getElementById("progress_text");(new o.hH6).setResponseType("arraybuffer").load("/3d_models/"+n+".tar.gz",(function(n){return K(t,void 0,void 0,(function(){var t,e,a,i,c,l,s,d,f,v,m,p;return N(this,(function(h){switch(h.label){case 0:return t=u.ec(new Uint8Array(n)),[4,Q(t.buffer).then((function(n){console.log(n)}),(function(n){console.log(n)}),(function(n){if(console.log(n),"grid.bin"===n.name)e=n.buffer;else if("grid.json"===n.name){var t=n.readAsJSON();a=t.GRID_RES,O=t.GRID_HALF_SIDE;var r=t.FORMAT;i="UCHAR"==r?o.ywz:o.VzW}}))];case 1:return h.sent(),c=new Uint8Array(e),(l=new o.JUT(c,a[0],a[1],a[2])).format=o.wk1,l.type=i,l.magFilter=o.wem,l.minFilter=o.wem,l.needsUpdate=!0,l.generateMipmaps=!1,s=$,d=o.rDY.clone(s.uniforms),f=O.map((function(n){return-n})),v=O.map((function(n){return n})),d.u_aabb_min.value=f,d.u_aabb_max.value=v,d.u_data.value=l,d.transformMatrix.value=(new o.yGw).identity(),m=new o.jyz({uniforms:d,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,side:o._Li}),p=new o.DvJ(2,2,2),(J=new o.Kj0(p,m)).scale.set(O[0],O[1],O[2]),J.onBeforeRender=function(n,t,e,a,r,o){r.uniforms.transformMatrix.value.copy(H.matrix)},r.style.display="none",X.add(J),_=W,b=X,x=L,y=[Math.PI/2,Math.PI,Math.PI],I.d.setupStats(),S=_,k=b,z=x,B.Rotation.X=y[0],B.Rotation.Y=y[1],B.Rotation.Z=y[2],D(B["Use headtracking"]),[2]}var _,b,x,y}))}))}),(function(n){n.loaded===n.total?l.innerHTML="Unpacking...":l.innerHTML=Math.round(n.loaded/n.total*100)+"%",c.value=n.loaded/n.total*100}),(function(n){console.log("Error: "+n)}))}function tn(){var n=G();L.aspect=n[0]/n[1],L.updateProjectionMatrix(),W.setSize(n[0],n[1])}}}]);