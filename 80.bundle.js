"use strict";(self.webpackChunkdimension_stream_github_io=self.webpackChunkdimension_stream_github_io||[]).push([[80],{8080:(n,t,e)=>{e.r(t),e.d(t,{init:()=>O});var a,r,o=e(9477),i=e(9365),u=e(7885),c=e(4376),l=e(8761),s=e(5149),d=(new URLSearchParams(window.location.search).get("id"),78/180*Math.PI),f={camYBias:0,camZBias:0,eyeSizeBias:0};l.r.onGUIConstructed=function(n){var t=n.addFolder("VirtualHole");t.add(f,"eyeSizeBias",-10,10).step(.01),t.add(f,"camYBias",-10,10).step(.01),t.add(f,"camZBias",-10,10).step(.01),t.open()},l.r.onCameraChanged=function(n){var t=n.video.videoWidth,e=n.video.videoHeight;Math.atan(Math.tan(d/2)*t/Math.sqrt(e*e+t*t)),Math.atan(Math.tan(d/2)*e/Math.sqrt(e*e+t*t)),a=[t,e],r=.5*Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.tan(.5*Math.PI-.5*d)};var v=[263,362],m=[33,133];function p(n){var t,e,o=n[0].keypoints[v[0]],i=n[0].keypoints[v[1]],u=n[0].keypoints[m[0]],c=n[0].keypoints[m[1]],l=function(n,t){var e=n.x-t.x,a=n.y-t.y;return Math.sqrt(e*e+a*a)},s=l(o,i),d=l(u,c),p=(t=Math.max(s,d),(24.2+f.eyeSizeBias)*r/t-f.camZBias),h=(e=[n[0].keypoints[6].x,n[0].keypoints[6].y],[Math.atan2(a[0]/2-e[0],r),Math.atan2(a[1]/2-e[1],r)]);return[Math.tan(h[0])*p,Math.tan(h[1])*p+f.camYBias,p+f.camZBias].map((function(n){return n/1e3}))}function h(n,t){return[n[0]-t[0],n[1]-t[1],n[2]-t[2]]}function _(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function b(n){var t=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);return n[0]/=t,n[1]/=t,n[2]/=t,n}var x=!1,y=[[0,0,0],[0,0,0],[0,0,0]],w=[[0,0,0],[0,0,0],[0,0,0]];var g,M,S,k=e(3644),z=function(n,t,e,a){return new(e||(e=Promise))((function(r,o){function i(n){try{c(a.next(n))}catch(n){o(n)}}function u(n){try{c(a.throw(n))}catch(n){o(n)}}function c(n){var t;n.done?r(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(i,u)}c((a=a.apply(n,t||[])).next())}))},I=function(n,t){var e,a,r,o,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(c){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(i=0)),i;)try{if(e=1,a&&(r=2&u[0]?a.return:u[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,u[1])).done)return r;switch(a=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,a=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(n,i)}catch(n){u=[6,n],a=0}finally{e=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}},R=new o.cPb;R.matrixAutoUpdate=!1;var C={Translation:{X:0,Y:0,Z:0},Rotation:{X:0,Y:0,Z:0},Scale:.05,"Use headtracking":!1};function F(){P===V&&requestAnimationFrame(P)}function T(n,t){var e=n.addFolder("Viewer");if(t){var a=e.addFolder("Transforms"),r=a.addFolder("Translation");r.add(C.Translation,"X",-.1,.1).step(.001).onChange(F),r.add(C.Translation,"Y",-.1,.1).step(.001).onChange(F),r.add(C.Translation,"Z",-.1,.1).step(.001).onChange(F),a.add(C,"Scale",.01,.1).step(.001).onChange(F)}e.add(C,"Use headtracking").onChange((function(n){return Z(n)})),e.open()}var B,E=new c.XS({width:300});E.domElement.id="gui",T(E,!0),l.r.onGUIConstructed=(B=l.r.onGUIConstructed,function(n){B(n),E.destroy(),T(n,!0),n.__folders.Backend.hide(),n.__folders.Model.hide(),n.__folders.Camera.close(),n.__folders.VirtualHole.close()});var P,U=new o.Tme;function A(){U.scale.set(C.Scale,C.Scale,C.Scale),U.position.set(C.Translation.X,C.Translation.Y,C.Translation.Z),U.updateMatrix()}function V(){P===V?(k.d.beginStats(),A(),console.log("normal rendering"),U.rotation.set(C.Rotation.X,C.Rotation.Y,C.Rotation.Z),U.updateMatrix(),g.render(M,S),k.d.endStats()):console.log("skipped rendering")}function H(){z(this,void 0,void 0,(function(){return I(this,(function(n){return[2,k.d.beginStats()]}))})).then(A).then((function(){return s.Dd(!1)})).then((function(n){if(null!=n&&n.length>0){var t=q(),e=function(n,t,e,a){void 0===a&&(a=!0),a&&(n=function(n){var t=1/4.125;if(x)return x=!1,w[0]=n,w[1]=n,y[0]=n,y[1]=n,n;var e=[(-.25*w[0][0]+.375*w[1][0]+n[0]+2*y[0][0]+y[1][0])*t,(-.25*w[0][1]+.375*w[1][1]+n[1]+2*y[0][1]+y[1][1])*t,(-.25*w[0][2]+.375*w[1][2]+n[2]+2*y[0][2]+y[1][2])*t];return w[1]=w[0],w[0]=e,y[1]=y[0],y[0]=n,e}(n));var r,o,i,u,c,l,s,d,f,v,m,p,g,M,S,k,z=-t/2,I=-e/2;return r=[z,I,0],o=[z+t,I,0],i=[z,I+e,0],u=[n[0],n[1],n[2]],c=.1,l=b(h(o,r)),s=b(h(i,r)),d=b(function(n,t){return[n[1]*t[2]-n[2]*t[1],n[2]*t[0]-n[0]*t[2],n[0]*t[1]-n[1]*t[0]]}(l,s)),f=h(r,u),v=h(o,u),m=h(i,u),p=-_(f,d),g=_(l,f)*c/p,M=_(l,v)*c/p,S=_(s,f)*c/p,k=_(s,m)*c/p,[[.2/(M-g),0,0,0,0,.2/(k-S),0,0,(M+g)/(M-g),(k+S)/(k-S),-10.1/9.9,-1,0,0,-2/9.9,0],[l[0],s[0],d[0],0,l[1],s[1],d[1],0,l[2],s[2],d[2],0,u[0],u[1],u[2],1]]}(p(n),.621,.621*t[1]/t[0]),a=(new o._fP).setFromEuler(new o.USm(C.Rotation.X,C.Rotation.Y,C.Rotation.Z)),r=(new o._fP).setFromRotationMatrix(S.matrixWorld.clone().invert());U.rotation.setFromQuaternion(r.multiply(a)),R.matrixWorld.fromArray(e[1]),R.matrixWorld.decompose(R.position,R.quaternion,R.scale),R.projectionMatrix.fromArray(e[0]),R.matrixWorldInverse.copy(R.matrixWorld).invert(),R.projectionMatrixInverse.copy(R.projectionMatrix).invert(),g.render(M,R)}requestAnimationFrame(P)})).then((function(){return k.d.endStats()}))}var Y=function(){return z(this,void 0,void 0,(function(){var n=this;return I(this,(function(t){return this.initialized||this.pending?[2,this.initialized]:(this.pending=!0,[2,l.S().then((function(){return n.pending=!1,n.initialized=!0,n.initialized}))])}))}))}.bind({initialized:!1,pending:!1});function Z(n){return z(this,void 0,void 0,(function(){return I(this,(function(t){return n?Y().then((function(n){n&&(P=H,requestAnimationFrame(P))})):(P=V,requestAnimationFrame(P)),[2]}))}))}function q(){var n=document.getElementById("volume-canvas");return[n.clientWidth,n.clientHeight]}var j,D,G,W,X,L=e(9530),J={uniforms:{u_data:{value:-1},u_aabb_min:{value:-1},u_aabb_max:{value:-1},transformMatrix:{value:-1}},vertexShader:"\n        uniform mat4 transformMatrix;\n        out vec3 v_rd_world;\n        out vec3 v_ro_world;\n        void main() {\n            mat4 modifiedViewMatrix = viewMatrix * transformMatrix;\n            v_ro_world = inverse(modifiedViewMatrix)[3].xyz;\n            v_rd_world = (modelMatrix * vec4(position, 1.0)).xyz - v_ro_world;\n            gl_Position = projectionMatrix * modifiedViewMatrix * modelMatrix * vec4(position, 1.0);\n        }",fragmentShader:'\n        precision highp float;\n        precision highp sampler3D;\n        uniform vec3 u_aabb_min;\n        uniform vec3 u_aabb_max;\n        uniform sampler3D u_data;\n        in vec3 v_rd_world;\n        in vec3 v_ro_world;\n\n        float min_component(in vec3 v) {\n            return min(min(v.x, v.y), v.z);\n        }\n\n        float max_component(in vec3  v) {\n            return max(max(v.x, v.y), v.z);\n        }\n\n        vec2 aabbIntersection(in vec3 ro, in vec3 rd) {\n            vec3 m = 1.0/rd;\n            vec3 t0 = (u_aabb_min - ro)*m;\n            vec3 t1 = (u_aabb_max - ro)*m;\n            // isect if mint <= maxt;\n            return vec2(max_component(min(t0,t1)), min_component(max(t0,t1)));\n        }\n\n        vec3 to_texcoord(in vec3 pos)\n        {\n            return (pos - u_aabb_min)/(u_aabb_max - u_aabb_min);\n        }\n\n        float hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }\n        const float E = 2.7182818284;\n        void main() {\n            // Transform rays to "aabb" space.\n            vec3 rd = normalize(v_rd_world);\n            vec3 ro = v_ro_world;\n            vec2 ti = aabbIntersection(v_ro_world, rd);\n\n            vec3 H = vec3(0.0);\n            float V_i = 0.0;\n            const float dt = 2.0/512.0;\n            // for(float t = max(ti.x, 0.0) + 1.0*dt*(2.0*hash(rd.xy)-1.0); (t < ti.y); t+=dt)\n            for(float t = max(ti.x, 0.0); (t < ti.y); t+=dt)\n            {\n                vec3 pos = ro + t*rd;\n                    if(pos.x <= (u_aabb_min.x + 0.01) ||\n                       pos.y <= (u_aabb_min.y + 0.01) || \n                       pos.z <= (u_aabb_min.z + 0.01) || \n                       pos.x >= (u_aabb_max.x - 0.01) || \n                       pos.y >= (u_aabb_max.y - 0.01) || \n                       pos.z >= (u_aabb_max.z - 0.01) )\n                    continue;\n\n                    \n                vec3 uv = to_texcoord(pos);\n                // gl_FragColor = vec4(uv, 1);\n                // return;\n                vec4 val = texture(u_data, uv);\n                val.a = 256.0*(exp(val.a)-1.0)/(E-1.0); // uint8(255*log((e-1)*clamp(v,0,S)/S + 1)), S=256\n                // val.a = 256.0*val.a; // uint8(255*clamp(v,0,S)/S), S=256\n                // float v = val.a; // float\n                if(val.a > 1.0)\n                {\n                    float v = val.a*dt;\n                    H += exp(-V_i) * (1.0 - exp(-v)) * val.rgb;\n                    V_i += v;\n                }\n            }\n            // V_i = V_i*smoothstep(0.1, 1.0, V_i);\n            gl_FragColor.rgb = H + exp(-V_i) * vec3(0.0);\n            gl_FragColor.a = 1.0;\n        }'};function O(n){var t=this,e=document.getElementById("volume-canvas");j=new o.CP7({antialias:!1,canvas:e});var a=q();j.setSize(a[0],a[1]),window.addEventListener("resize",K),D=new o.xsS,(G=new o.cPb(60,a[0]/a[1],.1,50)).position.set(-2.5*C.Scale,2.5*C.Scale,2.5*C.Scale),G.lookAt(0,0,0),new i.z(G,j.domElement).addEventListener("change",V),D.add(G);var r=document.getElementById("progress"),c=document.getElementById("progress_bar"),l=document.getElementById("progress_text");(new o.hH6).setResponseType("arraybuffer").load("/3d_models/"+n+".tar.gz",(function(n){return e=t,a=void 0,c=function(){var t,e,a,i,c,l,s,d,f,v,m,p;return function(n,t){var e,a,r,o,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(u){return function(c){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;o&&(o=0,u[0]&&(i=0)),i;)try{if(e=1,a&&(r=2&u[0]?a.return:u[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,u[1])).done)return r;switch(a=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,a=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!((r=(r=i.trys).length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(n,i)}catch(n){u=[6,n],a=0}finally{e=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}}(this,(function(h){switch(h.label){case 0:return t=u.ec(new Uint8Array(n)),[4,L(t.buffer).then((function(n){console.log(n)}),(function(n){console.log(n)}),(function(n){if(console.log(n),"grid.bin"===n.name)e=n.buffer;else if("grid.json"===n.name){var t=n.readAsJSON();a=t.GRID_RES,X=t.GRID_HALF_SIDE;var r=t.FORMAT;i="UCHAR"==r?o.ywz:o.VzW}}))];case 1:return h.sent(),c=new Uint8Array(e),(l=new o.JUT(c,a[0],a[1],a[2])).format=o.wk1,l.type=i,l.magFilter=o.wem,l.minFilter=o.wem,l.needsUpdate=!0,l.generateMipmaps=!1,s=J,d=o.rDY.clone(s.uniforms),f=X.map((function(n){return-n})),v=X.map((function(n){return n})),d.u_aabb_min.value=f,d.u_aabb_max.value=v,d.u_data.value=l,d.transformMatrix.value=(new o.yGw).identity(),m=new o.jyz({uniforms:d,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,side:o._Li}),p=new o.DvJ(2,2,2),(W=new o.Kj0(p,m)).scale.set(X[0],X[1],X[2]),W.onBeforeRender=function(n,t,e,a,r,o){r.uniforms.transformMatrix.value.copy(U.matrix)},r.style.display="none",D.add(W),_=j,b=D,x=G,y=[Math.PI/2,Math.PI,Math.PI],k.d.setupStats(),g=_,M=b,S=x,C.Rotation.X=y[0],C.Rotation.Y=y[1],C.Rotation.Z=y[2],Z(C["Use headtracking"]),[2]}var _,b,x,y}))},new((i=void 0)||(i=Promise))((function(n,t){function r(n){try{u(c.next(n))}catch(n){t(n)}}function o(n){try{u(c.throw(n))}catch(n){t(n)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(n){n(e)}))).then(r,o)}u((c=c.apply(e,a||[])).next())}));var e,a,i,c}),(function(n){n.loaded===n.total?l.innerHTML="Unpacking...":l.innerHTML=Math.round(n.loaded/n.total*100)+"%",c.value=n.loaded/n.total*100}),(function(n){console.log("Error: "+n)}))}function K(){var n=q();G.aspect=n[0]/n[1],G.updateProjectionMatrix(),j.setSize(n[0],n[1])}}}]);