/*! For license information please see 866.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkdimension_stream_github_io=self.webpackChunkdimension_stream_github_io||[]).push([[866],{1866:(e,n,t)=>{t.r(n),t.d(n,{init:()=>W,toggleHeadTracking:()=>j});var a,i,r=t(9477),o=t(9365),d=t(7885),s=t(8761),c=(new URLSearchParams(window.location.search).get("id"),78/180*Math.PI),l={camYBias:0,camZBias:0,eyeSizeBias:0};s.r.onGUIConstructed=function(e){var n=e.addFolder("VirtualHole");n.add(l,"eyeSizeBias",-10,10).step(.01),n.add(l,"camYBias",-10,10).step(.01),n.add(l,"camZBias",-10,10).step(.01),n.open()};var u=24.2;s.r.onCameraChanged=function(e){var n=e.video.videoWidth,t=e.video.videoHeight;Math.atan(Math.tan(c/2)*n/Math.sqrt(t*t+n*n)),Math.atan(Math.tan(c/2)*t/Math.sqrt(t*t+n*n)),a=[n,t],i=.5*Math.sqrt(a[0]*a[0]+a[1]*a[1])*Math.tan(.5*Math.PI-.5*c)};var v=[263,362],f=[33,133],m=6;function h(e,n){return[e[0]-n[0],e[1]-n[1],e[2]-n[2]]}function p(e,n){return e[0]*n[0]+e[1]*n[1]+e[2]*n[2]}function g(e){var n=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return e[0]/=n,e[1]/=n,e[2]/=n,e}var y=!1,w=[[0,0,0],[0,0,0],[0,0,0]],_=[[0,0,0],[0,0,0],[0,0,0]];var x,b,M,C,S,z=t(2694),k=t(4376),I=function(e,n,t,a){return new(t||(t=Promise))((function(i,r){function o(e){try{s(a.next(e))}catch(e){r(e)}}function d(e){try{s(a.throw(e))}catch(e){r(e)}}function s(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,d)}s((a=a.apply(e,n||[])).next())}))},P=function(e,n){var t,a,i,r,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:d(0),throw:d(1),return:d(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function d(d){return function(s){return function(d){if(t)throw new TypeError("Generator is already executing.");for(;r&&(r=0,d[0]&&(o=0)),o;)try{if(t=1,a&&(i=2&d[0]?a.return:d[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,d[1])).done)return i;switch(a=0,i&&(d=[2&d[0],i.value]),d[0]){case 0:case 1:i=d;break;case 4:return o.label++,{value:d[1],done:!1};case 5:o.label++,a=d[1],d=[0];continue;case 7:d=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==d[0]&&2!==d[0])){o=0;continue}if(3===d[0]&&(!i||d[1]>i[0]&&d[1]<i[3])){o.label=d[1];break}if(6===d[0]&&o.label<i[1]){o.label=i[1],i=d;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(d);break}i[2]&&o.ops.pop(),o.trys.pop();continue}d=n.call(e,o)}catch(e){d=[6,e],a=0}finally{t=i=0}if(5&d[0])throw d[1];return{value:d[0]?d[1]:void 0,done:!0}}([d,s])}}},B=t(9530),F=.621,H=.341,U={tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,s:.05,"Use headtracking":!1};function E(e,n){var t=e.addFolder("Viewer");if(n){var a=t.addFolder("Transforms");a.add(U,"tx",-.1,.1).step(.001),a.add(U,"ty",-.1,.1).step(.001),a.add(U,"tz",-.1,.1).step(.001),a.add(U,"rx",0,2*Math.PI).step(.001),a.add(U,"ry",0,2*Math.PI).step(.001),a.add(U,"rz",0,2*Math.PI).step(.001),a.add(U,"s",.01,.1).step(.001)}t.add(U,"Use headtracking").onChange((function(e){return j(e)})),t.open()}var V,A,T=new k.XS({width:300});function D(){A===D?(console.log("normal rendering"),x.render(b,M)):console.log("skipped rendering")}function q(){C.rotation.set(Math.PI/2+U.rx,Math.PI+U.ry,Math.PI+U.rz),C.scale.set(U.s*S[0],U.s*S[1],U.s*S[2]),C.position.set(U.tx,U.ty,U.tz),z.Dd(!1).then((function(e){if(null!=e&&e.length>0){var n=function(e,n,t,a){void 0===a&&(a=!0),a&&(e=function(e){var n=1/4.125;if(y)return y=!1,_[0]=e,_[1]=e,w[0]=e,w[1]=e,e;var t=[(-.25*_[0][0]+.375*_[1][0]+e[0]+2*w[0][0]+w[1][0])*n,(-.25*_[0][1]+.375*_[1][1]+e[1]+2*w[0][1]+w[1][1])*n,(-.25*_[0][2]+.375*_[1][2]+e[2]+2*w[0][2]+w[1][2])*n];return _[1]=_[0],_[0]=t,w[1]=w[0],w[0]=e,t}(e));var i,r,o,d,s,c,l,u,v,f,m,x,b,M,C,S,z=-n/2,k=-t/2;return i=[z,k,0],r=[z+n,k,0],o=[z,k+t,0],d=[e[0],e[1],e[2]],s=.1,c=g(h(r,i)),l=g(h(o,i)),u=g(function(e,n){return[e[1]*n[2]-e[2]*n[1],e[2]*n[0]-e[0]*n[2],e[0]*n[1]-e[1]*n[0]]}(c,l)),v=h(i,d),f=h(r,d),m=h(o,d),x=-p(v,u),b=p(c,v)*s/x,M=p(c,f)*s/x,C=p(l,v)*s/x,S=p(l,m)*s/x,[[.2/(M-b),0,0,0,0,.2/(S-C),0,0,(M+b)/(M-b),(S+C)/(S-C),-10.1/9.9,-1,0,0,-2/9.9,0],[c[0],l[0],u[0],0,c[1],l[1],u[1],0,c[2],l[2],u[2],0,d[0],d[1],d[2],1]]}(function(e){var n,t,r=e[0].keypoints[v[0]],o=e[0].keypoints[v[1]],d=e[0].keypoints[f[0]],s=e[0].keypoints[f[1]],c=function(e,n){var t=e.x-n.x,a=e.y-n.y;return Math.sqrt(t*t+a*a)},h=c(r,o),p=c(d,s),g=(n=Math.max(h,p),(u+l.eyeSizeBias)*i/n-l.camZBias),y=(t=[e[0].keypoints[m].x,e[0].keypoints[m].y],[Math.atan2(a[0]/2-t[0],i),Math.atan2(a[1]/2-t[1],i)]);return[Math.tan(y[0])*g,Math.tan(y[1])*g+l.camYBias,g+l.camZBias].map((function(e){return e/1e3}))}(e),F,H);(new r.yGw).fromArray(n[1]).decompose(M.position,M.quaternion,M.scale),M.projectionMatrix.fromArray(n[0]),M.projectionMatrixInverse.copy(M.projectionMatrix).invert(),M.updateMatrixWorld(),x.render(b,M)}requestAnimationFrame(A)}))}T.domElement.id="gui",E(T,!1),s.r.onGUIConstructed=(V=s.r.onGUIConstructed,function(e){V(e),T.destroy(),E(e,!0),e.__folders.Backend.hide(),e.__folders.Model.hide(),e.__folders.Camera.close(),e.__folders.VirtualHole.close()});var R=function(){return I(this,void 0,void 0,(function(){var e=this;return P(this,(function(n){return this.initialized||this.pending?[2,this.initialized]:(this.pending=!0,[2,s.S().then((function(){return e.pending=!1,e.initialized=!0,e.initialized}))])}))}))}.bind({initialized:!1,pending:!1});function j(e){return I(this,void 0,void 0,(function(){return P(this,(function(n){return e?R().then((function(e){e&&(A=q,requestAnimationFrame(A))})):(A=D,requestAnimationFrame(A)),[2]}))}))}var G={uniforms:{u_data:{value:-1},u_inv_modelview_pos:{value:-1}},vertexShader:'\n        uniform vec3 u_inv_modelview_pos;\n        out vec3 v_rd;\n        void main() {\n            // Transform rd to "aabb" space.\n            v_rd = position.xyz - u_inv_modelview_pos;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }',fragmentShader:'\n        precision highp float;\n        precision highp sampler3D;\n        uniform vec3 u_inv_modelview_pos;\n        uniform sampler3D u_data;\n        in vec3 v_rd;\n\n        float min_component(in vec3 v) {\n            return min(min(v.x, v.y), v.z);\n        }\n\n        float max_component(in vec3  v) {\n            return max(max(v.x, v.y), v.z);\n        }\n\n        // Intersect a ray with aabb where aabb.mix.xyz = -1, and aabb.max.xyz = 1.\n        // returns vec2(min_t, max_t).\n        vec2 boxIntersection(in vec3 ro, in vec3 rd) {\n            vec3 m = 1.0/rd;\n            vec3 n = ro*m;\n            vec3 t0 = -m - n;\n            vec3 t1 = m - n;\n            // isect if mint <= maxt;\n            return vec2(max_component(min(t0,t1)), min_component(max(t0,t1)));\n        }\n\n        float hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }\n        const float E = 2.7182818284;\n        void main() {\n            // Transform rays to "aabb" space.\n            vec3 rd = normalize(v_rd);\n            vec3 ro = u_inv_modelview_pos;\n            vec2 ti = boxIntersection(ro, rd);\n\n            vec3 H = vec3(0.0);\n            float V_i = 0.0;\n            const float dt = 2.0/512.0;\n            // for(float t = max(ti.x, 0.0) + 1.0*dt*(2.0*hash(rd.xy)-1.0); (t < ti.y); t+=dt)\n            for(float t = max(ti.x, 0.0); (t < ti.y); t+=dt)\n            {\n                vec3 pos = ro + t*rd;\n                // pos.xyz is in range (-1, 1).\n                vec3 uv = 0.5*pos+0.5;\n                vec4 val = texture(u_data, uv);\n                val.a = 256.0*(exp(val.a)-1.0)/(E-1.0); // uint8(255*log((e-1)*clamp(v,0,S)/S + 1)), S=256\n                // val.a = 256.0*val.a; // uint8(255*clamp(v,0,S)/S), S=256\n                // float v = val.a; // float\n                if(val.a > 1.0)\n                {\n                    float v = val.a*dt;\n                    H += exp(-V_i) * (1.0 - exp(-v)) * val.rgb;\n                    V_i += v;\n                }\n            }\n            // V_i = V_i*smoothstep(0.1, 1.0, V_i);\n            gl_FragColor.rgb = H + exp(-V_i) * vec3(0.0);\n            gl_FragColor.a = 1.0;\n        }'};function L(){var e=document.getElementById("volume-canvas");return[e.clientWidth,e.clientHeight]}function W(e){var n=this,t=document.getElementById("volume-canvas");x=new r.CP7({antialias:!1,canvas:t});var a=L();x.setSize(a[0],a[1]),window.addEventListener("resize",O),b=new r.xsS,(M=new r.cPb(60,a[0]/a[1],.1,50)).position.set(-2.5,2.5,2.5),M.lookAt(0,0,0),new o.z(M,x.domElement).addEventListener("change",D),b.add(M);var i=document.getElementById("progress"),s=document.getElementById("progress_bar"),c=document.getElementById("progress_text");(new r.hH6).setResponseType("arraybuffer").load("/3d_models/"+e+".tar.gz",(function(e){return I(n,void 0,void 0,(function(){var n,t,a,o,s,c,l,u,v,f;return P(this,(function(m){switch(m.label){case 0:return n=d.ec(new Uint8Array(e)),[4,B(n.buffer).then((function(e){console.log(e)}),(function(e){console.log(e)}),(function(e){if(console.log(e),"grid.bin"===e.name)t=e.buffer;else if("grid.json"===e.name){var n=e.readAsJSON();a=n.GRID_RES,S=n.GRID_HALF_SIDE;var i=n.FORMAT;o="UCHAR"==i?r.ywz:r.VzW}}))];case 1:return m.sent(),s=new Uint8Array(t),(c=new r.JUT(s,a[0],a[1],a[2])).format=r.wk1,c.type=o,c.magFilter=r.wem,c.minFilter=r.wem,c.needsUpdate=!0,c.generateMipmaps=!1,l=G,(u=r.rDY.clone(l.uniforms)).u_data.value=c,u.u_inv_modelview_pos.value=new r.Pa4,v=new r.jyz({uniforms:u,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,side:r._Li}),f=new r.DvJ(2,2,2),(C=new r.Kj0(f,v)).rotation.set(Math.PI/2,Math.PI,Math.PI),C.scale.set(S[0],S[1],S[2]),C.onBeforeRender=function(e,n,t,a,i,r){i.uniforms.u_inv_modelview_pos.value.setFromMatrixColumn(t.matrixWorldInverse.clone().multiply(C.matrixWorld).invert(),3)},b.add(C),i.style.display="none",j(U["Use headtracking"]),[2]}}))}))}),(function(e){e.loaded===e.total?c.innerHTML="Unpacking...":c.innerHTML=Math.round(e.loaded/e.total*100)+"%",s.value=e.loaded/e.total*100}),(function(e){console.log("Error: "+e)}))}function O(){var e=L();M.aspect=e[0]/e[1],M.updateProjectionMatrix(),x.setSize(e[0],e[1])}},2694:(e,n,t)=>{t.d(n,{Dd:()=>x,S1:()=>b,rr:()=>y}),t(9059);var a=t(3224),i=t(999),r=t(7155),o=t(3644),d=t(8734);const s=!1;let c,l,u,v,f,m=0,h=0,p=0;const g={stats:u,beginStats:function(){},endStats:function(){}},y={onChanged:function(e){},onCameraChanged:function(e){},onGUIConstructed:function(e){}};function w(){v=(performance||Date).now()}function _(){const e=(performance||Date).now();if(h+=e-v,++m,e-p>=1e3){const n=h/m;h=0,m=0,u.customFpsPanel.update(1e3/n,120),p=e}}async function x(e=!0){let n=null;return await async function(){if((r.ed.isTargetFPSChanged||r.ed.isSizeOptionChanged)&&(l=await a.V.setupCamera(r.ed.camera),r.ed.isTargetFPSChanged=!1,r.ed.isSizeOptionChanged=!1,y.onCameraChanged(l)),r.ed.isModelChanged||r.ed.isFlagChanged||r.ed.isBackendChanged){r.ed.isModelChanged=!0,window.cancelAnimationFrame(f),null!=c&&c.dispose(),(r.ed.isFlagChanged||r.ed.isBackendChanged)&&await(0,d.Qt)(r.ed.flags,r.ed.backend);try{c=await(0,r.cH)(r.ed.model)}catch(e){c=null,alert(e)}r.ed.isFlagChanged=!1,r.ed.isBackendChanged=!1,r.ed.isModelChanged=!1}}(),r.ed.isModelChanged||(n=async function(e){l.video.readyState<2&&await new Promise((e=>{l.video.onloadeddata=()=>{e()}}));let n=null;if(null!=c){s&&w();try{n=await c.estimateFaces(l.video,{flipHorizontal:!1}),y.onChanged(n)}catch(e){c.dispose(),c=null,alert(e)}s&&_()}return e&&(document.querySelector(".camera-canvas-wrapper").style.display="block",l.drawCtx(),n&&n.length>0&&!r.ed.isModelChanged&&l.drawResults(n,r.ed.modelConfig.triangulateMesh,r.ed.modelConfig.boundingBox)),n}(e)),n}async function b(){const e=new URLSearchParams(window.location.search),n=await(0,i.j)(e);y.onGUIConstructed(n),u=(0,o.t)(),g.stats=u,g.beginStats=w,g.endStats=_,l=await a.V.setupCamera(r.ed.camera),y.onCameraChanged(l),await(0,d.Qt)(r.ed.flags,r.ed.backend),c=await(0,r.cH)(),console.log("face detector created")}}}]);